<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark's Casino</title>
    <style>
        /* --- General Styling --- */
        :root {
            /* Casino Palette */
            --color-primary: #FFD700; /* Gold */
            --color-secondary: #00bcd4; /* Accent Blue */
            --color-background: #1c1c1c; 
            --color-surface: #2a2a2a; 
            --color-text: #f0f0f0; 
            --color-shadow: rgba(0, 0, 0, 0.7);
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--color-background); 
            color: var(--color-text); 
            padding-top: 150px; /* Increased padding to accommodate fixed navigation */
            padding-bottom: 20px;
            text-align: center;
            background-image: url('data:image:svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231c1c1c"/><g fill="none" stroke="%23303030" stroke-width="1.5"><path d="M50 0v100M0 50h100M0 0l100 100M100 0L0 100"/></g></svg>');
            background-size: 50px 50px;
        }
        
        /* --- SITE NAVIGATION/HEADER BAR --- */
        .header-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #000000;
            color: var(--color-primary);
            box-shadow: 0 4px 10px var(--color-shadow);
            z-index: 1000;
            padding: 10px 0;
        }
        .header-bar h1 {
            margin: 0;
            font-size: 2.5em;
        }
        
        .nav-bar {
            background-color: #111;
            padding: 10px 0;
            border-top: 1px solid #333;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .nav-bar a {
            color: var(--color-secondary);
            text-decoration: none;
            padding: 8px 15px;
            border: 1px solid var(--color-secondary);
            border-radius: 5px;
            transition: background-color 0.2s, color 0.2s;
            font-weight: bold;
        }
        .nav-bar a:hover {
            background-color: var(--color-secondary);
            color: #111;
        }

        /* Balance Container */
        .balance { 
            font-size: 1.6em; 
            padding: 15px 35px; 
            border: 2px solid var(--color-primary); 
            background: linear-gradient(145deg, var(--color-surface), #1a1a1a); 
            border-radius: 15px; 
            display: inline-block;
            box-shadow: 0 6px 20px var(--color-shadow);
            margin-top: 40px; 
        }
        
        /* --- GAME CONTAINER --- */
        .game-container { 
            background-color: var(--color-surface); 
            padding: 30px; 
            margin: 25px auto; 
            border-radius: 15px; 
            box-shadow: 0 5px 15px var(--color-shadow);
            max-width: 800px;
            border-top: 5px solid var(--color-primary); 
            text-align: left;
        }
        
        h2 { 
            color: var(--color-primary); 
            border-bottom: 1px solid #444; 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
            font-size: 2em;
            text-align: center;
        }
        
        /* Game Display Areas (Cards, Hands) */
        .hand-display { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            margin-top: 15px; 
            margin-bottom: 25px;
            min-height: 70px; 
            flex-wrap: wrap; 
            align-items: center; 
            text-align: center;
            padding: 15px;
            background-color: #121212; 
            border-radius: 10px;
            border: 1px solid #444;
        }
        
        /* --- Form Elements and Buttons --- */
        .game-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap; 
            padding-top: 15px;
        }
        
        .bet-control-group {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }

        input[type="number"], select { 
            padding: 12px; 
            border: 1px solid #444; 
            border-radius: 8px; 
            width: 140px;
            background-color: #333;
            color: var(--color-text);
            outline: none;
        }
        
        button { 
            padding: 12px 25px; 
            background-color: var(--color-primary); 
            color: #121212; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1em; 
            font-weight: bold;
            box-shadow: 0 4px #b8a032; 
            margin: 5px;
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s;
        }

        button:active {
            box-shadow: 0 1px #b8a032; 
            transform: translateY(3px);
        }
        
        .max-bet-btn {
            background-color: #555;
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
            margin-left: -5px; 
            border-radius: 0 8px 8px 0;
            box-shadow: none;
            height: 42px; 
            line-height: 1.5;
            border: 1px solid #444;
            border-left: none;
        }

        /* --- Result Feedback --- */
        .result { 
            margin-top: 25px; 
            font-weight: bold; 
            padding: 15px; 
            border-radius: 10px; 
            font-size: 1.3em;
            opacity: 0; 
            transition: opacity 0.5s ease-in-out;
            text-align: center;
        }
        .result.show { opacity: 1; }
        .win { background-color: #4caf50; color: white; }
        .lose { background-color: #f44336; color: white; }
        .push { background-color: #ff9800; color: #121212; }

        @keyframes jackpot-flash {
            0% { background-color: #4caf50; }
            50% { background-color: #FFD700; color: #121212; }
            100% { background-color: #4caf50; }
        }
        .result.win.jackpot {
            animation: jackpot-flash 0.5s ease-in-out 3;
        }

        /* --- Card Styles (Standard) --- */
        @keyframes dealAnimation {
            0% { transform: translateY(-50px) rotateY(90deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(0) rotateY(0deg); opacity: 1; }
        }
        
        .card { 
            padding: 15px 10px; 
            width: 50px;
            border: 1px solid #777; 
            background-color: #ffffff; 
            border-radius: 8px;
            color: black;
            font-size: 1.3em;
            box-shadow: 0 3px 6px var(--color-shadow);
            opacity: 0; 
            transform: translateY(-50px);
            animation: dealAnimation 0.5s ease-out forwards; 
        }

        .card.hidden {
            background-color: #555;
            color: #555;
            border-color: #333;
            box-shadow: none;
            opacity: 1; 
            animation: none; 
            transform: none;
        }

        /* --- COIN FLIP STYLES (Simple Coin) --- */
        .coin-display {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px; 
            margin-bottom: 20px;
            perspective: 1000px; /* Needed for 3D flip effect */
        }

        .coin {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #DAA520, #FFD700); 
            border: 5px solid #a88b00;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            font-weight: bold;
            transition: all 0.1s; 
            transform: rotateY(0deg); 
            color: #1c1c1c;
            /* Added for smooth 3D flip */
            transform-style: preserve-3d; 
        }
        
        /* FIX: Updated the flipping animation to a proper 3D flip */
        .coin.flipping {
            animation: coin-flip 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; 
        }
        @keyframes coin-flip {
            0% { transform: scale(1) rotateY(0deg); opacity: 1; }
            50% { transform: scale(0.8) rotateY(1800deg); opacity: 0.8; }
            100% { transform: scale(1) rotateY(3600deg); opacity: 1; }
        }

        /* --- SLOTS BOXES ENHANCEMENT --- */
        .slot-reels {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 25px 0;
            margin: 20px auto;
            width: 90%;
            background-color: #121212;
            border: 5px solid #555;
            border-radius: 10px;
            box-shadow: inset 0 0 10px #000;
        }
        .reel {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5em;
            padding: 10px;
            margin: 0 10px;
            width: 80px;
            height: 80px;
            background-color: #333; 
            border: 3px solid var(--color-primary);
            border-radius: 8px;
            color: var(--color-primary);
            font-weight: bold;
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.1);
            transition: transform 0.2s;
        }

        /* --- ROULETTE ENHANCEMENT --- */
        .roulette-display-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .roulette-number-display {
            font-size: 3em;
            font-weight: bold;
            padding: 20px 30px;
            border: 5px solid #8B0000; 
            background-color: #121212; 
            color: var(--color-text);
            border-radius: 15px;
            min-width: 150px;
            text-align: center;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
            transition: all 0.5s;
        }

        .roulette-number-display.RED { color: #f44336; }
        .roulette-number-display.BLACK { color: #555; border-color: #333; box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);}
        .roulette-number-display.GREEN { 
            color: #4caf50; 
            border-color: #4caf50; 
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.8);
        }

        /* --- Land Mines & Russian Roulette Styles (Simple Grid/Cells) --- */
        .mine-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            width: 350px; 
            margin: 20px auto;
        }

        .mine-cell {
            width: 60px;
            height: 60px;
            background-color: #333; 
            border: 2px solid #555;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: var(--color-text);
            cursor: pointer;
            user-select: none;
            transition: background-color 0.1s;
            font-weight: bold;
        }

        .mine-cell.safe { background-color: #12803c; color: white; cursor: default; }
        .mine-cell.mine { background-color: #8B0000; color: white; cursor: default; }

        /* --- SECRET MESSAGE STYLING --- */
        .secret-message {
            position: fixed;
            bottom: 5px;
            left: 5px;
            font-size: 8px; 
            color: #f0000f; /* Low contrast with the dark background */
            z-index: 9999;
        }
    </style>
</head>
<body>

    <div class="header-bar">
        <h1>💰 Mark's Casino 💰</h1>
        <div class="nav-bar">
            <a href="#loreSection">✨ Casino Lore</a>
            <a href="#landMines">💣 Mines</a>
            <a href="#coinFlip">🥇 Coin Flip</a>
            <a href="#blackjack">♠️ Blackjack</a>
            <a href="#slots">🎰 Slots</a>
            <a href="#roulette">🔴 Roulette</a>
            <a href="#poker">🃏 Poker</a>
            <a href="#russianRoulette">🩸 Russian Roulette</a>
            <a href="#updatesPanel">📢 Updates</a>
        </div>
    </div>

    <div class="balance-container">
        <div class="balance">
            Current Balance: <span id="balance">1000</span> Credits
        </div>
    </div>

    <div class="game-container" id="updatesPanel" style="max-width: 800px; margin: 25px auto;">
        <h2>Latest Casino Updates 📢</h2>
        <ul style="list-style-type: none; padding: 0; text-align: left; max-width: 500px; margin: 0 auto; line-height: 1.8;">
            <li><span style="color: var(--color-primary);">--v1.5--</span>Secret message :O // no new games..? // fixed the update panel bc i was sleepy asf</li>
            <li><span style="color: var(--color-primary);">--v1.4--</span>LOTS of WD-40 // fixed..? // added update panel tho</li>
            <li><span style="color: var(--color-primary);">--v1.3--</span>Ruski roulete added :O // bug WD-40 // improved mine game and ruski</li>
            <li><span style="color: var(--color-primary);">--v1.2--</span>Mine game added.. uh.. OH YEAH AND COIN GAME // WD-40</li>
            <li><span style="color: var(--color-primary);">--v1.1--</span>Bug fix. With WD-40 // New design :O // thats it.</li>
        </ul>
    </div>
    <hr>

    <div class="game-container" id="landMines">
        <h2>Land Mines 💣</h2>
        <p style="text-align:center;">
            Click to reveal cash multipliers! Avoid the mines. Cash out anytime.
        </p>
        
        <div id="mineGrid" class="mine-grid">
            </div>

        <div class="game-controls">
            <label for="minesBet">Bet Amount:</label>
            <div class="bet-control-group">
                <input type="number" id="minesBet" value="100" min="10">
                <button class="max-bet-btn" onclick="setMaxBet('mines')">MAX</button>
            </div>
            <label for="mineCount" style="margin-left: 15px;">Mines:</label>
            <select id="mineCount" style="width:100px; margin-right: 15px;">
                <option value="3">3 Mines</option>
                <option value="5">5 Mines</option>
                <option value="8">8 Mines</option>
            </select>
            <button id="minesStartButton" onclick="startNewMinesGame()">Start Game</button>
            <button id="minesCashOutButton" onclick="cashOutMines()" disabled style="background-color: #4CAF50;">Cash Out ($0)</button>
        </div>
        <div id="minesResult" class="result"></div>
    </div>

    <hr>

    <div class="game-container" id="coinFlip">
        <h2>Heads or Tails 🥇</h2>
        <p style="text-align:center;">Standard Payout 2x. Edge Payout 50x (1 in 100 chance).</p>
        
        <div class="coin-display">
            <div id="coin" class="coin">?</div>
        </div>
        
        <div class="game-controls">
            <label for="coinBet">Bet Amount:</label>
            <div class="bet-control-group">
                <input type="number" id="coinBet" value="100" min="10">
                <button class="max-bet-btn" onclick="setMaxBet('coin')">MAX</button>
            </div>
            <select id="coinSelection" style="width:140px; margin:5px;">
                <option value="Heads">Heads (2x)</option>
                <option value="Tails">Tails (2x)</option>
                <option value="Edge">Edge (50x)</option>
            </select>
            <button id="coinButton" onclick="playCoinFlip()">Flip Coin</button>
        </div>
        <div id="coinFlipResult" class="result"></div>
    </div>

    <hr>

    <div class="game-container" id="blackjack">
        <h2>Blackjack 21 ♠️</h2>
        <div class="hand-display">
            <span>Dealer Hand</span> (<span id="dealerScore">--</span>): <span id="dealerHand">--</span>
        </div>
        <div class="hand-display">
            <span>Your Hand</span> (<span id="playerScore">--</span>): <span id="playerHand">--</span>
        </div>
        <div class="game-controls">
            <label for="blackjackBet">Bet Amount:</label>
            <div class="bet-control-group">
                <input type="number" id="blackjackBet" value="100" min="10">
                <button class="max-bet-btn" onclick="setMaxBet('blackjack')">MAX</button>
            </div>
            <button id="dealButton" onclick="dealBlackjack()">Deal</button>
            <button id="hitButton" onclick="hit()" disabled>Hit</button>
            <button id="standButton" onclick="stand()" disabled>Stand</button>
        </div>
        <div id="blackjackResult" class="result"></div>
    </div>

    <hr>

    <div class="game-container" id="slots">
        <h2>Lucky Slots 🎰</h2>
        <div class="slot-reels">
            <div id="reel1" class="reel">?</div>
            <div id="reel2" class="reel">?</div>
            <div id="reel3" class="reel">?</div>
        </div>
        
        <p style="text-align:center; color:#999; margin-top:0;">
            Match 3 symbols to win big! Different symbols offer different multipliers.
        </p>

        <div class="game-controls">
            <label for="slotBet">Bet Amount:</label>
            <div class="bet-control-group">
                <input type="number" id="slotBet" value="100" min="10">
                <button class="max-bet-btn" onclick="setMaxBet('slot')">MAX</button>
            </div>
            <button id="slotButton" onclick="playSlots()">Spin Reels</button>
        </div>
        <div id="slotResult" class="result"></div>
    </div>

    <hr>

    <div class="game-container" id="roulette">
        <h2>Grand Roulette (0-12) 🟢🔴⚫</h2>
        
        <div class="roulette-display-container">
            <div id="rouletteNumberDisplay" class="roulette-number-display">--</div>
        </div>

        <div class="game-controls">
            <label for="rouletteBet">Bet Amount:</label>
            <div class="bet-control-group">
                <input type="number" id="rouletteBet" value="100" min="10">
                <button class="max-bet-btn" onclick="setMaxBet('roulette')">MAX</button>
            </div>
            <select id="rouletteSelection" style="width:200px; margin:5px;">
                <optgroup label="Single Number (12x)">
                    <option value="num1">Number 1</option>
                    <option value="num7">Number 7</option>
                </optgroup>
                <optgroup label="Column Bets (3x)">
                    <option value="col1">Column 1 (1, 2, 3, 4)</option>
                    <option value="col2">Column 2 (5, 6, 7, 8)</option>
                    <option value="col3">Column 3 (9, 10, 11, 12)</option>
                </optgroup>
                <optgroup label="Even Money (2x)">
                    <option value="green">Green (0) - 13x</option>
                    <option value="red">Red (1, 3, 5, 7, 9, 11)</option>
                    <option value="black">Black (2, 4, 6, 8, 10, 12)</option>
                    <option value="odd">Odd (1, 3, 5, 7, 9, 11)</option>
                    <option value="even">Even (2, 4, 6, 8, 10, 12)</option>
                    <option value="low">Low (1-6)</option>
                    <option value="high">High (7-12)</option>
                </optgroup>
            </select>
            <button id="rouletteButton" onclick="playRoulette()">Spin Wheel</button>
        </div>
        <div id="rouletteResult" class="result"></div>
    </div>

    <hr>

    <div class="game-container" id="poker">
        <h2>Classic 5-Card Draw Poker 🃏</h2>
        <p style="text-align:center;">Goal: Beat the Dealer's hand rank!</p>

        <p style="text-align:center; color:#999; margin-top:0;">
            Winning hands receive payouts based on hand rarity (Pair 2x up to Straight Flush 20x).
        </p>

        <div class="hand-display" id="playerPokerHand"><span>Your Hand</span>: --</div>
        <div class="hand-display" id="dealerPokerHand"><span>Dealer Hand</span>: --</div>
        <div class="game-controls">
            <label for="pokerBet">Bet Amount:</label>
            <div class="bet-control-group">
                <input type="number" id="pokerBet" value="100" min="10">
                <button class="max-bet-btn" onclick="setMaxBet('poker')">MAX</button>
            </div>
            <button id="pokerButton" onclick="playPoker()">Deal Cards</button>
        </div>
        <div id="pokerResult" class="result"></div>
    </div>

    <hr>

    <div class="game-container" id="russianRoulette">
        <h2>Russian Roulette 🩸</h2>
        <p style="text-align:center;">
            Six chambers. One bullet. Choose a chamber. Survive to double your bet (2x payout).
        </p>
        
        <div id="chamberGrid" class="mine-grid" style="width: 450px; grid-template-columns: repeat(6, 1fr); margin-bottom: 25px;">
        </div>

        <div class="game-controls">
            <label for="rrBet">Bet Amount:</label>
            <div class="bet-control-group">
                <input type="number" id="rrBet" value="100" min="10">
                <button class="max-bet-btn" onclick="setMaxBet('rr')">MAX</button>
            </div>
            <button id="rrStartButton" onclick="startRussianRoulette()">Load Revolver (Start)</button>
        </div>
        <div id="rrResult" class="result"></div>
    </div>

    <hr>

    <div class="game-container" id="loreSection">
        <h2>Casino Lore: Mark's Existential Bet 🔴</h2>
        <div style="text-align: center; max-width: 600px; margin: 0 auto; line-height: 1.6;">
            <p>This entire, highly questionable operation started with a <strong>whim and zero plannin</strong>. The founder, <strong>Mark</strong>, was simply trying to find a project more interesting than his own life. The concept wasn't born from genius or ambition, but from a reckless compulsion.</p>
            <p>Mark built this casino to mirror his own life philosophy: **bet everything on Red**. He runs the code like a perpetually drunk high-roller, constantly losing faith in the algorithms, tweaking the payouts at random, and often losing more to the House than any player.</p>
            <p style="color: #ff9800; font-weight: bold; margin-top: 20px;">
                <span style="font-size: 1.2em;">🚨 Terms & Conditions (Mark's Version) 🚨</span><br>
                We legally advise you to "follow the rules." They were drafted by <strong>Mark</strong> using only a magic eight ball, a vague memory of a children's board game, and the philosophical question, "What is gambling, really?" <strong> NOT try to exploit the code.</strong> Not because it's wrong, but because if Mark catches you, he'll replace your entire balance with a single 🥔 emoji. You have been warned.
            </p>
            <div id="termsPrompt" style="margin-top: 30px; padding: 15px; border: 2px solid var(--color-secondary); border-radius: 10px;">
                <p style="font-weight: bold; font-size: 1.1em; color: var(--color-secondary);"> Do you accept Mark's Chaos Rule Terms & Conditions? </p>
                <button onclick="handleTermsAcceptance(true)" style="background-color: #4CAF50; color: white;">Accept Terms</button>
                <button onclick="handleTermsAcceptance(false)" style="background-color: #f44336; margin-left: 10px; color: white;">Decline Terms</button>
            </div>
            <div id="termsStatus" style="margin-top: 20px; font-weight: bold; min-height: 20px;"></div>
            <p style="color: var(--color-primary); font-weight: bold; font-style: italic; margin-top: 20px;">
                Mark is the bank, the source of the chaos, and the house's worst player. Remember that the code is held together by pure despair and the faint hope that the next spin will finally land on black—for him.
            </p>
        </div>
    </div>
    
    <div class="secret-message">if you read this you are gay</div>

    <script>
        // --- 1. BALANCE INITIALIZATION (NOW RESETS TO 1000 ON REFRESH) ---
        let balance = 1000;
        const balanceDisplay = document.getElementById('balance');
        
        // Load terms status from localStorage (still necessary for T&C lockout persistence)
        let termsDeclined = localStorage.getItem('termsDeclined') === 'true'; 

        const suits = ['♠️', '♥️', '♦️', '♣️'];
        const cardValues = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const rankMap = { '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13, 'A': 14 };
        
        // --- NEW TERMS ACCEPTANCE LOGIC (WITH PERSISTENCE CHECK) ---
        function handleTermsAcceptance(accepted) {
            localStorage.setItem('termsDeclined', accepted ? 'false' : 'true');
            termsDeclined = !accepted;
            
            checkTermsStatus(); // Apply the lock/unlock immediately
        }

        function checkTermsStatus() {
            const promptDiv = document.getElementById('termsPrompt');
            const statusDiv = document.getElementById('termsStatus');
            const allGameInputs = document.querySelectorAll('input[type="number"], select');
            const allGameButtons = document.querySelectorAll('button:not(.max-bet-btn)');
            const balanceDiv = document.querySelector('.balance');

            if (termsDeclined) {
                promptDiv.style.display = 'none';
                
                // 1. Lock the balance to a potato emoji
                balanceDiv.innerHTML = 
                    'Current Balance: <span style="font-size: 1.2em;">🥔</span><br><strong>CASINO LOCKED.</strong> You declined Mark\'s terms and have been judged.';
                
                // 2. Disable all buttons and inputs
                allGameButtons.forEach(btn => {
                    btn.disabled = true;
                });
                allGameInputs.forEach(input => {
                    input.disabled = true;
                });
                
                // 3. Disable mine grid clicks (if Land Mines is active)
                document.querySelectorAll('.mine-cell').forEach(cell => cell.onclick = null);

                statusDiv.innerHTML = '<span style="color: #f44336; font-size: 1.2em;">❌ <strong>DECLINED:</strong> You failed the existential test. Mark has replaced your balance with a 🥔 and locked the casino.</span>';
            } else {
                 // If terms are accepted, ensure UI is normal
                promptDiv.style.display = 'none';
                statusDiv.innerHTML = '<span style="color: #4CAF50;">✅ <strong>Terms Accepted:</strong> Welcome to the Chaos. Play responsibly (Mark won\'t).</span>';
                
                // FORCE RE-ENABLE EVERYTHING (Defensive fix for persistence issues)
                allGameInputs.forEach(input => {
                    input.disabled = false;
                });
                allGameButtons.forEach(btn => {
                    btn.disabled = false;
                });
                
                // 4. Ensure balance is shown correctly and buttons are enabled based on actual balance
                updateBalance(0); 
            }
        }
        

        // --- Log and Balance Functions ---
        function updateBalance(amount) {
            if (termsDeclined) return; // Prevent any balance change if terms are declined
            
            balance += amount;
            balanceDisplay.textContent = balance.toLocaleString();

            if (balance < 10) {
                document.querySelectorAll('button:not(.max-bet-btn)').forEach(btn => {
                    btn.disabled = true;
                });
                balanceDisplay.textContent += " (OUT OF CREDITS! Refresh to restart)";
            } else {
                // Re-enable all game start/spin/deal buttons if balance is sufficient
                document.getElementById('slotButton').disabled = false;
                document.getElementById('rouletteButton').disabled = false;
                document.getElementById('pokerButton').disabled = false;
                document.getElementById('dealButton').disabled = false;
                document.getElementById('coinButton').disabled = false;
                document.getElementById('minesStartButton').disabled = false;
                document.getElementById('rrStartButton').disabled = false; 
                document.getElementById('minesCashOutButton').disabled = true; // Should start disabled
            }
        }

        // --- Utility Functions ---
        function setMaxBet(gameId) {
            const betInput = document.getElementById(`${gameId}Bet`);
            const maxBet = Math.max(10, balance);
            betInput.value = maxBet;
        }

        function showResult(div, message, type, isJackpot = false) {
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            div.innerHTML = message;
            div.className = `result ${type} show ${isJackpot ? 'jackpot' : ''}`;
            setTimeout(() => {
                div.classList.remove('show');
                div.classList.remove('jackpot');
            }, 5000);
        }

        function disableButtons(disabled) {
            if (termsDeclined && disabled === false) return; // Prevent re-enabling if declined
            
            document.getElementById('slotButton').disabled = disabled;
            document.getElementById('rouletteButton').disabled = disabled;
            document.getElementById('pokerButton').disabled = disabled;
            document.getElementById('dealButton').disabled = disabled;
            document.getElementById('coinButton').disabled = disabled;
            document.getElementById('minesStartButton').disabled = disabled;
            document.getElementById('minesCashOutButton').disabled = disabled;
            document.getElementById('rrStartButton').disabled = disabled; 
        }

        function createDeck() {
            const deck = [];
            for (const suit of suits) {
                for (const value of cardValues) {
                    let rank = rankMap[value] || 10;
                    let blackjackRank = (value === 'A') ? 11 : rank;
                    deck.push({ value: value, suit: suit, rank: rank, blackjackRank: blackjackRank });
                }
            }
            return deck;
        }

        function dealCard(deck) {
            const randomIndex = Math.floor(Math.random() * deck.length);
            const card = deck.splice(randomIndex, 1)[0];
            return card;
        }

        // --- POKER LOGIC ---

        function isStraight(ranks) {
            ranks = [...new Set(ranks)].sort((a, b) => a - b);
            if (ranks.length < 5) return false;
            
            // Handle standard straight 
            for (let i = 0; i <= ranks.length - 5; i++) {
                if (ranks[i+4] === ranks[i] + 4) return true;
            }

            // Handle A-2-3-4-5 low straight (A=14, treats as 1)
            const lowStraight = [2, 3, 4, 5, 14];
            if (lowStraight.every(r => ranks.includes(r))) return true;

            return false;
        }

        function getHandRank(hand) {
            const ranks = hand.map(card => card.rank).sort((a, b) => a - b);
            const suits = hand.map(card => card.suit);
            
            const rankCounts = ranks.reduce((acc, rank) => {
                acc[rank] = (acc[rank] || 0) + 1;
                return acc;
            }, {});
            
            const suitCounts = suits.reduce((acc, suit) => {
                acc[suit] = (acc[suit] || 0) + 1;
                return acc;
            }, {});

            const counts = Object.values(rankCounts).sort((a, b) => b - a);
            const isFlush = Object.values(suitCounts).some(count => count >= 5);
            const isStraightHand = isStraight(ranks);
            
            if (isStraightHand && isFlush) return { rank: 'Straight Flush', strength: 8, kicker: ranks[ranks.length-1] };
            if (counts[0] === 4) return { rank: 'Four of a Kind', strength: 7, kicker: ranks.find(r => rankCounts[r] === 4) };
            if (counts[0] === 3 && counts[1] === 2) return { rank: 'Full House', strength: 6, kicker: ranks.find(r => rankCounts[r] === 3) };
            if (isFlush) return { rank: 'Flush', strength: 5, kicker: ranks[ranks.length-1] };
            if (isStraightHand) return { rank: 'Straight', strength: 4, kicker: ranks[ranks.length-1] };
            if (counts[0] === 3) return { rank: 'Three of a Kind', strength: 3, kicker: ranks.find(r => rankCounts[r] === 3) };
            if (counts[0] === 2 && counts[1] === 2) return { rank: 'Two Pair', strength: 2, kicker: ranks.find(r => rankCounts[r] === 2) };
            if (counts[0] === 2) return { rank: 'Pair', strength: 1, kicker: ranks.find(r => rankCounts[r] === 2) };

            return { rank: 'High Card', strength: 0, kicker: ranks[ranks.length-1] };
        }

        function compareHands(playerRank, dealerRank) {
            if (playerRank.strength > dealerRank.strength) return 1; // Player wins
            if (playerRank.strength < dealerRank.strength) return -1; // Dealer wins
            
            // Tie breaker logic (simplified: compare the primary kicker)
            if (playerRank.kicker > dealerRank.kicker) return 1;
            if (playerRank.kicker < dealerRank.kicker) return -1;

            return 0; // Push (Full Tie)
        }

        // --- POKER GAME (FIXED) ---
        async function playPoker() {
            const betInput = document.getElementById('pokerBet');
            const bet = parseInt(betInput.value);
            const resultDiv = document.getElementById('pokerResult');
            const playerHandDiv = document.getElementById('playerPokerHand');
            const dealerHandDiv = document.getElementById('dealerPokerHand');

            if (bet > balance || bet <= 0) {
                showResult(resultDiv, 'Invalid bet or insufficient balance!', 'lose');
                return;
            }
            disableButtons(true);
            updateBalance(-bet);

            playerHandDiv.innerHTML = '<span>Your Hand</span>: ';
            dealerHandDiv.innerHTML = '<span>Dealer Hand</span>: ';
            
            let pokerDeck = createDeck();
            const playerHand = [];
            const dealerHand = [];
            
            for (let i = 0; i < 5; i++) {
                 playerHand.push(dealCard(pokerDeck));
                 dealerHand.push(dealCard(pokerDeck));
            }
            
            // Render with staggered animation delay
            playerHand.forEach((card, index) => {
                const pCard = document.createElement('span');
                pCard.className = 'card';
                pCard.textContent = `${card.value}${card.suit}`;
                pCard.style.animationDelay = `${index * 0.2}s`;
                playerHandDiv.appendChild(pCard);
            });
            dealerHand.forEach((card, index) => {
                const dCard = document.createElement('span');
                dCard.className = 'card';
                dCard.textContent = `${card.value}${card.suit}`;
                dCard.style.animationDelay = `${(index * 0.2) + 0.3}s`; 
                dealerHandDiv.appendChild(dCard);
            });
            
            await new Promise(resolve => setTimeout(resolve, 2000)); 

            const playerRank = getHandRank(playerHand);
            const dealerRank = getHandRank(dealerHand);
            const result = compareHands(playerRank, dealerRank);

            let win = 0;
            let message = '';
            let type = 'lose';

            // Payouts are for total return multiplier (2x total = 1:1 profit)
            const payoutTable = {
                'Pair': 2, 'Two Pair': 3, 'Three of a Kind': 4, 'Straight': 5, 'Flush': 6, 
                'Full House': 8, 'Four of a Kind': 10, 'Straight Flush': 20
            };

            const premiumPayout = payoutTable[playerRank.rank];

            // --- POKER PAYOUT LOGIC FIX ---
            if (result === 1) { 
                if (premiumPayout) {
                    // Premium Payout: Multiplier * Bet
                    win = bet * premiumPayout;
                    const profit = win - bet;
                    message = `✅ You win! Your <strong>${playerRank.rank}</strong> beat the Dealer's ${dealerRank.rank}. Payout: ${premiumPayout}x. You won <strong>${profit.toLocaleString()}</strong> Credits! Total: ${win.toLocaleString()}`;
                } else {
                    // Standard Win (e.g., High Card beats High Card): 1:1 profit (2x total return)
                    win = bet * 2;
                    message = `✅ You win! Your <strong>${playerRank.rank}</strong> beat the Dealer's ${dealerRank.rank}. You won <strong>${bet.toLocaleString()}</strong> Credits! Total: ${win.toLocaleString()} Credits.`;
                }
                type = 'win';
            } else if (result === 0) { 
                win = bet;
                message = `🤝 It's a <strong>PUSH</strong>! Both hands tied with <strong>${playerRank.rank}</strong>. Bet returned.`;
                type = 'push';
            } else { 
                 message = `Dealer wins! Your ${playerRank.rank} was beaten by the Dealer's <strong>${dealerRank.rank}</strong>. You lost.`;
                type = 'lose';
            }

            updateBalance(win);
            showResult(resultDiv, message, type);
            disableButtons(false);
            document.getElementById('pokerButton').disabled = false;
        }

        // --- BLACKJACK LOGIC ---
        let bjDeck, playerHandBJ, dealerHandBJ;

        function getCardValue(card) {
            if (card.value === 'A') return 11;
            if (['K', 'Q', 'J'].includes(card.value)) return 10;
            return parseInt(card.value);
        }

        function calculateScore(hand, hideSecond = false) {
            let score = 0;
            let aces = 0;
            
            // Start from the second card if hiding the second card
            const startIndex = hideSecond ? 1 : 0;

            for (let i = startIndex; i < hand.length; i++) {
                const card = hand[i];
                if (card.value === 'A') {
                    aces++;
                }
                score += getCardValue(card);
            }

            while (score > 21 && aces > 0) {
                score -= 10;
                aces--;
            }
            return score;
        }

        function renderHands(hideDealerSecond = false) {
            const playerDiv = document.getElementById('playerHand');
            const dealerDiv = document.getElementById('dealerHand');
            const playerScoreSpan = document.getElementById('playerScore');
            const dealerScoreSpan = document.getElementById('dealerScore');

            // Clear previous cards
            playerDiv.innerHTML = '';
            dealerDiv.innerHTML = '';

            // Render Player Hand
            playerHandBJ.forEach((card, index) => {
                const pCard = document.createElement('span');
                pCard.className = 'card';
                pCard.textContent = `${card.value}${card.suit}`;
                pCard.style.animationDelay = `${index * 0.2}s`;
                playerDiv.appendChild(pCard);
            });
            playerScoreSpan.textContent = calculateScore(playerHandBJ);

            // Render Dealer Hand
            dealerHandBJ.forEach((card, index) => {
                const dCard = document.createElement('span');
                dCard.className = 'card';
                if (hideDealerSecond && index === 1) {
                    dCard.classList.add('hidden');
                    dCard.textContent = '🂠';
                } else {
                    dCard.textContent = `${card.value}${card.suit}`;
                }
                dCard.style.animationDelay = `${index * 0.2}s`;
                dealerDiv.appendChild(dCard);
            });

            // Calculate and display dealer score (only based on visible card if hidden)
            dealerScoreSpan.textContent = calculateScore(dealerHandBJ, hideDealerSecond);
        }

        async function dealBlackjack() {
            const betInput = document.getElementById('blackjackBet');
            const bet = parseInt(betInput.value);
            const resultDiv = document.getElementById('blackjackResult');

            if (bet > balance || bet <= 0) {
                showResult(resultDiv, 'Invalid bet or insufficient balance!', 'lose');
                return;
            }

            disableButtons(true);
            document.getElementById('dealButton').disabled = true;
            updateBalance(-bet);
            
            bjDeck = createDeck();
            playerHandBJ = [];
            dealerHandBJ = [];

            // Deal two cards each
            playerHandBJ.push(dealCard(bjDeck));
            dealerHandBJ.push(dealCard(bjDeck));
            playerHandBJ.push(dealCard(bjDeck));
            dealerHandBJ.push(dealCard(bjDeck));
            
            renderHands(true); 

            await new Promise(resolve => setTimeout(resolve, 1500));

            const playerScore = calculateScore(playerHandBJ);
            const dealerScore = calculateScore(dealerHandBJ);
            
            if (playerScore === 21 && dealerScore !== 21) {
                const win = bet * 2.5; // Blackjack pays 3:2
                updateBalance(win + bet); 
                showResult(resultDiv, `♠️ **BLACKJACK!** You win 3:2! You won **${win.toLocaleString()}** Credits!`, 'win');
                disableButtons(false);
            } else if (playerScore === 21 && dealerScore === 21) {
                updateBalance(bet); 
                showResult(resultDiv, '🤝 Both you and the Dealer have Blackjack! **PUSH**. Bet returned.', 'push');
                disableButtons(false);
            } else if (dealerScore === 21) {
                showResult(resultDiv, 'Dealer has **BLACKJACK!** You lose.', 'lose');
                disableButtons(false);
            } else {
                document.getElementById('hitButton').disabled = false;
                document.getElementById('standButton').disabled = false;
            }
        }

        function hit() {
            playerHandBJ.push(dealCard(bjDeck));
            renderHands(true);
            const playerScore = calculateScore(playerHandBJ);

            if (playerScore > 21) {
                document.getElementById('hitButton').disabled = true;
                document.getElementById('standButton').disabled = true;
                stand(true); // Auto-stand/lose
            }
        }

        async function stand(isBust = false) {
            document.getElementById('hitButton').disabled = true;
            document.getElementById('standButton').disabled = true;
            
            const bet = parseInt(document.getElementById('blackjackBet').value);
            const resultDiv = document.getElementById('blackjackResult');

            if (isBust) {
                showResult(resultDiv, '💥 **BUST!** Your score is over 21. You lose.', 'lose');
                disableButtons(false);
                return;
            }

            // Reveal dealer's hand
            renderHands(false);
            await new Promise(resolve => setTimeout(resolve, 1000));

            let dealerScore = calculateScore(dealerHandBJ);
            const playerScore = calculateScore(playerHandBJ);

            while (dealerScore < 17) {
                dealerHandBJ.push(dealCard(bjDeck));
                renderHands(false);
                dealerScore = calculateScore(dealerHandBJ);
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            let win = 0;
            let message = '';
            let type = 'lose';

            if (dealerScore > 21) {
                win = bet * 2;
                message = `🎉 Dealer **BUSTS!** You win! You won **${bet.toLocaleString()}** Credits!`;
                type = 'win';
            } else if (playerScore > dealerScore) {
                win = bet * 2;
                message = `✅ You win! Your ${playerScore} beat the Dealer's ${dealerScore}. You won **${bet.toLocaleString()}** Credits!`;
                type = 'win';
            } else if (playerScore < dealerScore) {
                message = `Dealer wins! Your ${playerScore} was beaten by the Dealer's ${dealerScore}. You lose.`;
                type = 'lose';
            } else {
                win = bet;
                message = `🤝 It's a **PUSH**! Both scores are ${playerScore}. Bet returned.`;
                type = 'push';
            }

            updateBalance(win);
            showResult(resultDiv, message, type);
            disableButtons(false);
        }

        // --- SLOTS LOGIC ---
        const slotSymbols = ['🍒', '🍋', '🔔', '7️⃣'];
        const slotPayouts = {
            '7️⃣': 10, // Jackpot
            '🔔': 5,
            '🍒': 3,
            '🍋': 2,
        };

        async function playSlots() {
            const betInput = document.getElementById('slotBet');
            const bet = parseInt(betInput.value);
            const resultDiv = document.getElementById('slotResult');
            
            if (bet > balance || bet <= 0) {
                showResult(resultDiv, 'Invalid bet or insufficient balance!', 'lose');
                return;
            }

            disableButtons(true);
            updateBalance(-bet);

            const reels = [
                document.getElementById('reel1'),
                document.getElementById('reel2'),
                document.getElementById('reel3'),
            ];

            // Animation (Simplified)
            let finalResults = [];
            for (let i = 0; i < 3; i++) {
                reels[i].classList.add('flipping');
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Stop reel
                const result = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                finalResults.push(result);
                reels[i].textContent = result;
                reels[i].classList.remove('flipping');
            }

            // Determine Payout
            const isTripleMatch = finalResults[0] === finalResults[1] && finalResults[1] === finalResults[2];
            
            // Check for a double match to provide a different losing message
            const isDoubleMatch = 
                (finalResults[0] === finalResults[1] && finalResults[1] !== finalResults[2]) || 
                (finalResults[1] === finalResults[2] && finalResults[0] !== finalResults[1]) ||
                (finalResults[0] === finalResults[2] && finalResults[0] !== finalResults[1]); 

            let win = 0;
            let message = '';
            let type = 'lose';
            
            if (isTripleMatch) {
                const symbol = finalResults[0];
                const multiplier = slotPayouts[symbol] || 1;
                win = bet * multiplier;
                const profit = win - bet;
                message = `🎉 **JACKPOT!** Triple ${symbol}! Payout: ${multiplier}x. You won **${profit.toLocaleString()}** Credits!`;
                type = 'win';
            } else if (isDoubleMatch) {
                // Better messaging for a near-miss
                message = `Close one! You hit a double match, but need three to win. Try again!`;
                type = 'lose'; 
            } else {
                message = `Spin lost. Try again!`;
                type = 'lose';
            }

            updateBalance(win);
            showResult(resultDiv, message, type, isTripleMatch && win >= 1000);
            disableButtons(false);
        }


        // --- ROULETTE LOGIC ---
        const redNumbers = [1, 3, 5, 7, 9, 11];
        const blackNumbers = [2, 4, 6, 8, 10, 12];

        async function playRoulette() {
            const betInput = document.getElementById('rouletteBet');
            const bet = parseInt(betInput.value);
            const selection = document.getElementById('rouletteSelection').value;
            const resultDiv = document.getElementById('rouletteResult');
            const numberDisplay = document.getElementById('rouletteNumberDisplay');

            if (bet > balance || bet <= 0) {
                showResult(resultDiv, 'Invalid bet or insufficient balance!', 'lose');
                return;
            }

            disableButtons(true);
            updateBalance(-bet);
            
            // Animation setup
            numberDisplay.textContent = '...';
            numberDisplay.className = 'roulette-number-display';

            // Simulate spinning
            await new Promise(resolve => setTimeout(resolve, 1500));

            // Spin result (0 to 12)
            const resultNumber = Math.floor(Math.random() * 13); 

            // Update display
            numberDisplay.textContent = resultNumber;
            if (resultNumber === 0) {
                numberDisplay.classList.add('GREEN');
            } else if (redNumbers.includes(resultNumber)) {
                numberDisplay.classList.add('RED');
            } else {
                numberDisplay.classList.add('BLACK');
            }

            let win = 0;
            let message = '';
            let type = 'lose';
            let multiplier = 0;

            // Determine win condition
            if (selection === 'green' && resultNumber === 0) {
                multiplier = 13; // Green (0) pays 13x total (12:1 profit)
            } else if (selection === 'red' && redNumbers.includes(resultNumber)) {
                multiplier = 2; // Red pays 2x total (1:1 profit)
            } else if (selection === 'black' && blackNumbers.includes(resultNumber)) {
                multiplier = 2; // Black pays 2x total (1:1 profit)
            } else if (selection === 'odd' && resultNumber !== 0 && resultNumber % 2 !== 0) {
                multiplier = 2; // Odd pays 2x total (1:1 profit)
            } else if (selection === 'even' && resultNumber !== 0 && resultNumber % 2 === 0) {
                multiplier = 2; // Even pays 2x total (1:1 profit)
            } else if (selection === 'low' && resultNumber >= 1 && resultNumber <= 6) {
                multiplier = 2; // Low (1-6) pays 2x total (1:1 profit)
            } else if (selection === 'high' && resultNumber >= 7 && resultNumber <= 12) {
                multiplier = 2; // High (7-12) pays 2x total (1:1 profit)
            } else if (selection.startsWith('num') && resultNumber === parseInt(selection.slice(3))) {
                multiplier = 13; // Single number pays 13x total (12:1 profit)
            } else if (selection.startsWith('col')) {
                const col = parseInt(selection.slice(3));
                const start = (col - 1) * 4 + 1;
                const end = col * 4;
                if (resultNumber >= start && resultNumber <= end) {
                    multiplier = 4; // Column pays 4x total (3:1 profit)
                }
            }


            if (multiplier > 0) {
                win = bet * multiplier;
                const profit = win - bet;
                message = `🎉 **${resultNumber}**! Your **${selection}** bet won! Payout: ${multiplier}x. You won **${profit.toLocaleString()}** Credits!`;
                type = 'win';
            } else {
                message = `💔 **${resultNumber}**! Your **${selection}** bet lost.`;
            }
            
            updateBalance(win);
            showResult(resultDiv, message, type, multiplier >= 10);
            disableButtons(false);
        }

        // --- LAND MINES LOGIC ---
        const mineMultipliers = {
            3: [1.33, 2.00, 3.00, 4.50, 6.75, 10.13, 15.19, 22.78, 34.17, 51.26, 76.89, 115.34, 173.01, 259.52, 389.28, 583.92, 875.88, 1313.82, 1970.73, 2956.10, 4434.15, 6651.22],
            5: [1.44, 2.39, 3.98, 6.63, 11.05, 18.42, 30.70, 51.17, 85.28, 142.13, 236.88, 394.80, 658.00, 1096.67, 1827.78, 3046.30, 5077.17, 8461.95, 14103.25, 23505.42, 39175.70, 65292.83],
            8: [1.74, 3.05, 5.34, 9.35, 16.36, 28.63, 50.11, 87.70, 153.48, 268.59, 469.96, 822.43, 1439.25, 2518.69, 4407.71, 7713.49, 13500.59, 23626.04, 41345.57, 72354.74, 126620.80, 221586.40]
        };
        const maxCells = 25; // 5x5 grid
        let gameActive = false;
        let mineLocations = [];
        let revealedCount = 0;
        let currentMultiplier = 0;
        let minesBet = 0;
        let numMines = 3;


        function startNewMinesGame() {
            const betInput = document.getElementById('minesBet');
            minesBet = parseInt(betInput.value);
            numMines = parseInt(document.getElementById('mineCount').value);
            const resultDiv = document.getElementById('minesResult');

            if (minesBet > balance || minesBet <= 0) {
                showResult(resultDiv, 'Invalid bet or insufficient balance!', 'lose');
                return;
            }
            if (gameActive) return;

            disableButtons(true);
            document.getElementById('minesCashOutButton').disabled = true;
            document.getElementById('minesStartButton').disabled = true;
            updateBalance(-minesBet);

            gameActive = true;
            revealedCount = 0;
            currentMultiplier = 0;
            mineLocations = [];

            // Place mines
            while (mineLocations.length < numMines) {
                const location = Math.floor(Math.random() * maxCells);
                if (!mineLocations.includes(location)) {
                    mineLocations.push(location);
                }
            }

            // Render grid
            const mineGrid = document.getElementById('mineGrid');
            mineGrid.innerHTML = '';
            for (let i = 0; i < maxCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'mine-cell';
                cell.id = `mineCell-${i}`;
                cell.onclick = () => revealCell(i);
                mineGrid.appendChild(cell);
            }
            showResult(resultDiv, `Game Started! ${numMines} Mines hidden.`, 'push');
        }

        function revealCell(index) {
            if (!gameActive) return;
            const cell = document.getElementById(`mineCell-${index}`);
            if (cell.classList.contains('safe') || cell.classList.contains('mine')) return;

            cell.onclick = null;

            if (mineLocations.includes(index)) {
                // Hit a mine
                cell.classList.add('mine');
                cell.textContent = '💣';
                endMinesGame(false, `💥 You hit a mine! You lose ${minesBet.toLocaleString()} Credits.`, index);
            } else {
                // Safe click
                revealedCount++;
                currentMultiplier = mineMultipliers[numMines][revealedCount - 1] || 1;
                const nextMultiplier = mineMultipliers[numMines][revealedCount] || 'MAX';
                const potentialWin = minesBet * currentMultiplier;

                cell.classList.add('safe');
                cell.textContent = `x${currentMultiplier.toFixed(2)}`;

                document.getElementById('minesCashOutButton').disabled = false;
                document.getElementById('minesCashOutButton').textContent = `Cash Out ($${potentialWin.toLocaleString()})`;
                
                // End game if all safe cells are revealed
                if (revealedCount >= maxCells - numMines) {
                    endMinesGame(true, `🎉 **MAX WIN!** You cleared all cells for a ${currentMultiplier.toFixed(2)}x win!`, index);
                }
            }
        }

        function cashOutMines() {
            if (!gameActive) return;
            endMinesGame(true, `You cashed out at **${currentMultiplier.toFixed(2)}x**! You won **${(minesBet * currentMultiplier - minesBet).toLocaleString()}** Credits!`);
        }

        function endMinesGame(isWin, message, hitIndex = -1) {
            gameActive = false;
            const finalWin = isWin ? minesBet * currentMultiplier : 0;
            const resultDiv = document.getElementById('minesResult');

            // Reveal all mines/chambers
            for (let i = 0; i < maxCells; i++) {
                const cell = document.getElementById(`mineCell-${i}`);
                cell.onclick = null;
                if (mineLocations.includes(i) && i !== hitIndex) {
                    cell.classList.add('mine');
                    cell.textContent = '💣';
                }
            }

            // --- MINES JACKPOT LOGIC FIX ---
            if (isWin) {
                updateBalance(finalWin);
                // Trigger jackpot flash if the final multiplier is 5.0x or higher
                showResult(resultDiv, message, 'win', currentMultiplier >= 5.0); 
            } else {
                showResult(resultDiv, message, 'lose');
            }

            disableButtons(false);
            document.getElementById('minesCashOutButton').textContent = `Cash Out ($0)`;
            document.getElementById('minesCashOutButton').disabled = true;
        }


        // --- COIN FLIP LOGIC (FIXED) ---
        async function playCoinFlip() {
            const betInput = document.getElementById('coinBet');
            const bet = parseInt(betInput.value);
            const selection = document.getElementById('coinSelection').value;
            const resultDiv = document.getElementById('coinFlipResult');
            const coinDiv = document.getElementById('coin');

            if (bet > balance || bet <= 0) {
                showResult(resultDiv, 'Invalid bet or insufficient balance!', 'lose');
                return;
            }

            disableButtons(true);
            updateBalance(-bet);
            
            // Animation setup
            coinDiv.textContent = '?';
            
            // FIX 1: Add the 'flipping' class to start the visual animation
            coinDiv.classList.add('flipping'); 

            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // FIX 2: Remove the 'flipping' class after the simulated flip time
            coinDiv.classList.remove('flipping'); 

            // Result
            let result = Math.random() < 0.5 ? 'Heads' : 'Tails';
            let isEdge = Math.random() < 0.01; // 1 in 100

            let win = 0;
            let message = '';
            let type = 'lose';
            let multiplier = 0;
            let isJackpot = false;

            if (isEdge) {
                result = 'EDGE';
                coinDiv.textContent = '📐';
                multiplier = 50;
            } else {
                coinDiv.textContent = result === 'Heads' ? 'HEADS' : 'TAILS';
                multiplier = 2; // Standard payout
            }

            if ((selection === result) || (selection === 'Heads' && result === 'HEADS') || (selection === 'Tails' && result === 'TAILS')) {
                win = bet * multiplier;
                const profit = win - bet;
                
                if (result === 'EDGE') {
                    message = `🤯 **UNBELIEVABLE!** The coin landed on the **EDGE**! Payout: 50x. You won **${profit.toLocaleString()}** Credits!`;
                    isJackpot = true;
                } else {
                    message = `🎉 **${result}**! You win ${multiplier}x! You won **${profit.toLocaleString()}** Credits!`;
                }
                type = 'win';
            } else {
                message = `💔 **${result === 'EDGE' ? 'EDGE' : result}**! You bet on ${selection}. You lost.`;
            }

            updateBalance(win);
            showResult(resultDiv, message, type, isJackpot);
            disableButtons(false);
        }


        // --- RUSSIAN ROULETTE LOGIC ---
        let rrGameActive = false;
        let bulletChamber = -1;
        let rrBet = 0;

        // FIX: Removed "Chamber X" text from cells when loading
        function startRussianRoulette() {
            const betInput = document.getElementById('rrBet');
            rrBet = parseInt(betInput.value);
            const resultDiv = document.getElementById('rrResult');

            if (rrBet > balance || rrBet <= 0) {
                showResult(resultDiv, 'Invalid bet or insufficient balance!', 'lose');
                return;
            }
            if (rrGameActive) return;

            disableButtons(true);
            document.getElementById('rrStartButton').disabled = true;
            updateBalance(-rrBet);

            rrGameActive = true;
            bulletChamber = Math.floor(Math.random() * 6); // 0 to 5

            // Render chamber grid (6 chambers)
            const chamberGrid = document.getElementById('chamberGrid');
            chamberGrid.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                const cell = document.createElement('div');
                cell.className = 'mine-cell'; // Reusing mine-cell style
                cell.id = `rrChamber-${i}`;
                // cell.textContent = `${i + 1}`; // Removed per user request
                cell.onclick = () => pullTrigger(i);
                chamberGrid.appendChild(cell);
            }
            showResult(resultDiv, `Revolver loaded. ${6 - 1} empty chambers. Choose wisely.`, 'push');
        }

        // FIX: Corrected the winning message to show profit, not total return
        function pullTrigger(chosenIndex) {
            if (!rrGameActive) return;
            rrGameActive = false; // Lock game while determining result

            document.querySelectorAll('#chamberGrid .mine-cell').forEach(cell => cell.onclick = null);

            const chamber = document.getElementById(`rrChamber-${chosenIndex}`);
            chamber.textContent = '⏳ ...';

            setTimeout(() => {
                let win = 0;
                let message = '';

                if (chosenIndex === bulletChamber) {
                    // Loss (Bullet)
                    chamber.textContent = '💥';
                    chamber.classList.add('mine');
                    message = `💀 **BANG!** Chamber ${chosenIndex + 1} was the bullet. You lost ${rrBet.toLocaleString()} Credits.`;
                    
                    // Reveal the other safe chambers
                    document.querySelectorAll('#chamberGrid .mine-cell').forEach((cell, index) => {
                         cell.onclick = null;
                         if (index !== bulletChamber) {
                             cell.classList.add('safe');
                             cell.textContent = 'Empty';
                         }
                    });

                    endRRGame(false, message);
                } else {
                    // Win (Survival)
                    chamber.textContent = 'Empty';
                    chamber.classList.remove('push');
                    chamber.classList.add('safe');
                    
                    win = rrBet * 2; // Total return (Bet + Profit)
                    const profit = rrBet;
                    
                    message = `🍾 **CLICK!** Chamber ${chosenIndex + 1} was empty! You survived and doubled your bet! You won <strong>${profit.toLocaleString()}</strong> Credits! Total Return: ${win.toLocaleString()} Credits.`;
                    
                    // Reveal the bullet chamber(s)
                    document.querySelectorAll('#chamberGrid .mine-cell').forEach((cell, index) => {
                         cell.onclick = null;
                         if (index === bulletChamber) {
                             cell.classList.add('mine');
                             cell.textContent = '💥';
                         }
                    });

                    endRRGame(true, message, win);
                }
            }, 1000);
        }

        function endRRGame(isWin, message, win = 0) {
            const resultDiv = document.getElementById('rrResult');
            const type = isWin ? 'win' : 'lose';

            if (isWin) {
                updateBalance(win);
            }
            
            showResult(resultDiv, message, type);
            disableButtons(false);
            document.getElementById('rrStartButton').disabled = false;
        }

        // Initial setup
        checkTermsStatus(); // Apply lock if previously declined
        updateBalance(0); // Update balance display and check for low balance state
    </script>

</body>
</html>